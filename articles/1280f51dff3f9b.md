---
title: "Supabase âœ–ï¸ Prisma âœ–ï¸ Next.jsã§ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦è¦‹ãŸ ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç·¨"
emoji: "ğŸ¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs","supabase","prisma"]
published: false
---

# åˆã‚ã«
ã“ã®ç« ã§ã¯supabaseã¨next.jsã‚’ä½¿ã£ãŸãƒ¡ãƒ¼ãƒ«èªè¨¼ã«ã¤ã„ã¦å–ã‚Šæ‰±ã„ã¾ã™ã€‚

ã“ã®ç« ã§ã®ç›®çš„ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
- emailã¨passwordã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã™ã‚‹
- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ã‚ˆã‚‹èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç™»éŒ²ã™ã‚‹


**ã»ã‹ã®è¨˜äº‹ä¸€è¦§**
- prismaã¨supabaseã®è¨­å®šã€‚
- supabaseã¨next.jsã‚’ä½¿ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
- prismaã‚’ä½¿ã£ãŸcrudæ“ä½œ
- supabase storageã‚’ä½¿ã£ã¦ç”»åƒã‚’ä¿å­˜ã™ã‚‹æ–¹æ³•

## ã©ã®ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã®ã‹
```mermaid
sequenceDiagram
    participant Client
    participant API
    participant Supabase
    participant Database
    
    Client->>API: POST /api/auth/register
    API->>API: å…¥åŠ›æ¤œè¨¼
    API->>Supabase: signUp(email, password)
    Supabase->>API: ãƒ¦ãƒ¼ã‚¶ãƒ¼UUID
    API->>Database: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    Database->>API: ç™»éŒ²å®Œäº†
    API->>Client: æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ã«ã¯`Supabase Auth`ã‚’ä½¿ã„ã¾ã™ã€‚
Supabase Authã«ã¯`auth.users`ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€Emailã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã“ã§å¤§äº‹ãªç‚¹ã¨ã—ã¦ã¯**auth.usersã«ã¯emailã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã—ã‹ç™»éŒ²ã§ããªã„**ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ãã®ãŸã‚ã€ãã®ä»–ã®æƒ…å ±ã¯åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€ä¿å­˜ã™ã‚‹æ–¹æ³•ãŒã‚ˆã„ã¨æ€ã„ã¾ã™ã€‚

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã«ã¤ã„ã¦
ã“ã®è¨˜äº‹ã§ã¯ã€Supabaseã®`auth.users`ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ç‹¬è‡ªã®`User`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½µç”¨ã™ã‚‹è¨­è¨ˆã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
å€‹äººçš„ã«ã¯`profile`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã£ã¦



## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã¾ãšã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã—ã¾ã™ã€‚ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
```bash
npm install @supabase/ssr @supabase/supabase-js
```
### supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
æ¬¡ã«Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ[^1]ã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚
[^1]: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã¯ç°¡å˜ã«è¨€ã†ã¨ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®èµ·ç‚¹ã§ã™ã€‚ã“ã‚Œã‚’è¨­å®šã™ã‚‹ã“ã¨ã§Supabaseã‚„Prismaã‚’ã‚³ãƒ¼ãƒ‰ä¸Šã§ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
`utils/supabase`ã®ä¸­ã«`server.ts`ã¨`client.ts`ã‚’æº–å‚™ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¼‰

```ts:utils/supabase/server.ts
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options),
            );
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    },
  );
}
```
```ts:utils/supabase/client.ts
import { createBrowserClient } from "@supabase/ssr";

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const createClient = () =>
  createBrowserClient(supabaseUrl, supabaseAnonKey);
```

ã“ã‚Œã§`createClient()`ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§Supabaseã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œã™ã‚‹å ´åˆã¯`server.ts`ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å‘¼ã³å‡ºã™å ´åˆã¯`client.ts`ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚


### prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
æœ€å¾Œã«prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
`lib/prisma.ts`ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¼‰ã€‚
```ts:lib/prisma.ts
import { PrismaClient } from "@prisma/client";
declare global {
  var prisma: PrismaClient | undefined;
}

const prisma = global.prisma || new PrismaClient();

if (process.env.NODE_ENV === "development") global.prisma = prisma;

export const db = prisma;
```

æœ€å¾Œã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```bash
npx prisma generate
```

ã“ã‚Œã§prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã§ãã¾ã—ãŸã€‚
`db`ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ“ä½œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
æ¬¡ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã«ã¤ã„ã¦å®Ÿè£…ã—ã¾ã™ã€‚
Next.jsã«ã¯`API Routes`ã¨`Server Actions`ãŒã‚ã‚Šã€ã©ã¡ã‚‰ã§ã‚‚å®Ÿè£…ã§ãã¾ã™ãŒã€
`API Routes`ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚
`app/api/auth/register/route.ts`ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¼‰ã—ã¾ã™ã€‚
```ts:api/auth/register/route.ts
import { createClient } from "@/utils/supabase/server";
import { NextRequest, NextResponse } from "next/server";
import { db } from "@/lib/prisma";

export async function POST(req: NextRequest) {
  try {
    const { name, email, password } = await req.json();

    if (!name || !email || !password) {
      return NextResponse.json(
        { error: "å…¥åŠ›é …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™" },
        { status: 400 },
      );
    }

    const supabase = await createClient(); // awaitã‚’ã¤ã‘ã‚‹

    const { data, error } = await supabase.auth.signUp({ 
      email,
      password,
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã«å¤±æ•—
    if (error) {
      return NextResponse.json(
        { error: error.message }, // supabaseã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        { status: 400 },
      );
    }

    // Supabaseã®ç™»éŒ²ã«æˆåŠŸ
    const userId = data.user?.id; // Supabaseã«ç™»éŒ²ã—ãŸUUIDã‚’ä½¿ç”¨ã™ã‚‹ã€‚
    if (!userId) {
      return NextResponse.json(
        { error: "ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" },
        { status: 400 },
      );
    }

    // Userãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã€‚
    try {
      await db.user.create({
        data: {
          id: userId,
          name,
          email,
          userIcon: "/default-icon.jpeg",
        },
      });
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã«å¤±æ•—ã—ãŸå ´åˆ
    } catch (error) {
      // Supabaseã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚å‰Šé™¤ã™ã‚‹
      await supabase.auth.admin.deleteUser(userId);

      return NextResponse.json(
        { error: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" },
        { status: 400 },
      );
    }

    // ç™»éŒ²ã«æˆåŠŸ
    return NextResponse.json(
      { message: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã«æˆåŠŸã—ã¾ã—ãŸ" },
      { status: 200 },
    );
  } catch (error) {
    return NextResponse.json(
      { error: "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" },
      { status: 500 },
    );
  }
}
```